<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forgot Password - Cloud-Based Attendance System</title>
  <%- include('partials/styles') %>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .forgot-password-container {
      background: #fff;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      width: 100%;
      max-width: 400px;
      text-align: center;
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .input-group {
      margin-bottom: 1rem;
      text-align: left;
    }
    .input-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #333;
    }
    .input-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    .input-group input:focus {
      border-color: #2575fc;
      outline: none;
    }
    .reset-button {
      width: 100%;
      padding: 0.75rem;
      background: #2575fc;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .reset-button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    .error-message {
      color: #ff4d4d;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      display: none;
    }
    .forgot-password-footer a {
      color: #2575fc;
      text-decoration: none;
    }
    #verification-section {
      display: none;
    }
  </style>
</head>
<body>
  <div class="forgot-password-container">
    <h1>Reset Password</h1>
    <p id="instruction-text">Enter your email to receive a verification code</p>

    <% if (messages && messages.error) { %>
      <div class="error-message" style="display: block;">
        <%= messages.error %>
      </div>
    <% } %>
    <% if (messages && messages.success) { %>
      <div class="error-message" style="color: #28a745; display: block;">
        <%= messages.success %>
      </div>
    <% } %>

    <form id="forgot-password-form">
      <div class="input-group">
        <label for="email">Email</label>
        <input type="email" id="email" placeholder="Enter your email" required>
      </div>
      <div id="verification-section">
        <div class="input-group">
          <label for="code">Verification Code</label>
          <input type="text" id="code" placeholder="Enter verification code">
        </div>
        <div class="input-group">
          <label for="new-password">New Password</label>
          <input type="password" id="new-password" placeholder="Enter new password">
        </div>
        <div class="input-group">
          <label for="confirm-password">Confirm Password</label>
          <input type="password" id="confirm-password" placeholder="Confirm new password">
        </div>
      </div>
      <div class="error-message" id="error-message"></div>
      <button type="submit" class="reset-button" id="resetButton">Send Verification Code</button>
    </form>

    <div class="forgot-password-footer">
      <p>Remember your password? <a href="/login">Login</a></p>
    </div>
  </div>

  <!-- Previous HTML remains the same until the script section -->
<script>
  const API_URL = "<%= process.env.API_URL %>";
  let emailSent = false;
  
  document.getElementById('forgot-password-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const button = document.getElementById('resetButton');
      const errorElement = document.getElementById('error-message');
      const email = document.getElementById('email').value;
      
      button.disabled = true;
      errorElement.style.display = 'none';

      try {
          if (!emailSent) {
              // Step 1: Send verification code
              button.textContent = 'Sending...';
              
              const response = await fetch(`${API_URL}/forgot-password`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ email })
              });

              const data = await response.json();

              if (!response.ok) {
                  throw new Error(data.message || "Failed to send verification code");
              }

              // Show verification fields
              document.getElementById('verification-section').style.display = 'block';
              document.getElementById('instruction-text').textContent = 'Check your email for the verification code';
              button.textContent = 'Reset Password';
              emailSent = true;
          } else {
              // Step 2: Submit verification code and new password
              button.textContent = 'Updating...';
              
              const code = document.getElementById('code').value;
              const newPassword = document.getElementById('new-password').value;
              const confirmPassword = document.getElementById('confirm-password').value;

              if (newPassword !== confirmPassword) {
                  throw new Error("Passwords don't match");
              }

              const response = await fetch(`${API_URL}/forgot-password`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ 
                      email, 
                      code, 
                      newPassword 
                  })
              });

              const data = await response.json();

              if (!response.ok) {
                  throw new Error(data.message || "Password reset failed");
              }

              alert('Password reset successfully! Please login with your new password.');
              window.location.href = '/login';
          }
      } catch (error) {
          errorElement.textContent = error.message;
          errorElement.style.display = 'block';
      } finally {
          button.disabled = false;
      }
  });
</script>
</body>
</html>